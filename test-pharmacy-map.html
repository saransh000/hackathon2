<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pharmacy Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 600px;
            width: 100%;
            border: 2px solid #333;
        }
        #info {
            margin: 20px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #357ae8;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è OpenStreetMap Pharmacy Finder Test</h1>
    
    <div id="info">
        <h3>Status: <span id="status">Initializing...</span></h3>
        <p><strong>Location:</strong> <span id="location">Detecting...</span></p>
        <p><strong>Pharmacies Found:</strong> <span id="count">0</span></p>
        <button onclick="searchPharmacies()">üîç Search Pharmacies</button>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = null;
        let userLocation = null;
        let markers = [];

        // Initialize map
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing map...');
            document.getElementById('status').textContent = 'Map loading...';
            
            // Default to New York
            const defaultLoc = [40.7128, -74.0060];
            
            map = L.map('map').setView(defaultLoc, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            console.log('Map created!');
            document.getElementById('status').textContent = 'Map loaded! Detecting location...';
            
            // Get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        console.log('User location:', userLocation);
                        
                        document.getElementById('location').textContent = 
                            `${userLocation[0].toFixed(4)}, ${userLocation[1].toFixed(4)}`;
                        
                        map.setView(userLocation, 14);
                        
                        // Add blue marker for user
                        L.circleMarker(userLocation, {
                            radius: 10,
                            fillColor: '#4285F4',
                            color: '#ffffff',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 1
                        }).addTo(map).bindPopup('üìç Your Location').openPopup();
                        
                        document.getElementById('status').textContent = 'Location detected! Click button to search.';
                        
                        // Auto-search
                        setTimeout(() => searchPharmacies(), 1000);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        document.getElementById('location').textContent = 'New York, NY (default)';
                        document.getElementById('status').textContent = 'Using default location. Click button to search.';
                        userLocation = defaultLoc;
                    }
                );
            } else {
                document.getElementById('location').textContent = 'Geolocation not supported';
                document.getElementById('status').textContent = 'Geolocation not available';
                userLocation = defaultLoc;
            }
        });

        async function searchPharmacies() {
            const loc = userLocation || [40.7128, -74.0060];
            const radius = 10000; // Increased to 10km
            
            document.getElementById('status').textContent = 'Searching...';
            console.log('Searching for pharmacies at:', loc, 'radius:', radius);
            
            try {
                const query = `
                    [out:json][timeout:25];
                    (
                        node["amenity"="pharmacy"](around:${radius},${loc[0]},${loc[1]});
                        way["amenity"="pharmacy"](around:${radius},${loc[0]},${loc[1]});
                        node["shop"="chemist"](around:${radius},${loc[0]},${loc[1]});
                        way["shop"="chemist"](around:${radius},${loc[0]},${loc[1]});
                        node["shop"="pharmacy"](around:${radius},${loc[0]},${loc[1]});
                        way["shop"="pharmacy"](around:${radius},${loc[0]},${loc[1]});
                        node["healthcare"="pharmacy"](around:${radius},${loc[0]},${loc[1]});
                        way["healthcare"="pharmacy"](around:${radius},${loc[0]},${loc[1]});
                        node["name"~"pharmacy|chemist|medical|drug",i](around:${radius},${loc[0]},${loc[1]});
                        way["name"~"pharmacy|chemist|medical|drug",i](around:${radius},${loc[0]},${loc[1]});
                    );
                    out center;
                `;
                
                console.log('Query:', query);
                
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });
                
                console.log('Response status:', response.status);
                
                const data = await response.json();
                console.log('Data received:', data);
                
                // Clear existing markers
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                
                if (data.elements && data.elements.length > 0) {
                    document.getElementById('count').textContent = data.elements.length;
                    document.getElementById('status').textContent = `Found ${data.elements.length} pharmacies!`;
                    
                    const bounds = L.latLngBounds();
                    if (userLocation) bounds.extend(userLocation);
                    
                    data.elements.forEach(pharmacy => {
                        const lat = pharmacy.lat || pharmacy.center.lat;
                        const lon = pharmacy.lon || pharmacy.center.lon;
                        const name = pharmacy.tags?.name || 'Unnamed Pharmacy';
                        const address = pharmacy.tags?.['addr:street'] || 'Address not available';
                        
                        const marker = L.marker([lat, lon], {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);
                        
                        marker.bindPopup(`<b>${name}</b><br>${address}`);
                        markers.push(marker);
                        bounds.extend([lat, lon]);
                    });
                    
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                } else {
                    document.getElementById('count').textContent = '0';
                    document.getElementById('status').textContent = 'No pharmacies found in OpenStreetMap database.';
                    alert('No pharmacies found within 10km.\n\nThis could mean:\n‚Ä¢ Your local pharmacies aren\'t in OpenStreetMap yet\n‚Ä¢ They may be tagged differently\n‚Ä¢ Try a major city location for testing\n\nOpenStreetMap is community-driven, so coverage varies by area.');
                }
                
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
                alert('Failed to search: ' + error.message);
            }
        }
    </script>
</body>
</html>
